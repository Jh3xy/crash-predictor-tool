{
  "version": 3,
  "sources": ["../../../src/oracle_do.js", "../../../src/worker-router.js"],
  "sourceRoot": "C:\\Users\\USER\\Desktop\\GitHub Desktop\\crash-predictor-tool\\stake-worker\\.wrangler\\tmp\\deploy-vxlBm5",
  "sourcesContent": ["\r\n// stake-worker/src/oracle_do.js - Fully corrected for secure polling\r\n\r\nexport default class OracleDO {\r\n  constructor(state, env) {\r\n    this.state = state;\r\n    this.env = env; // This contains the STAKE_TOKEN\r\n\r\n    this.clients = new Set();\r\n    this.history = [];\r\n    this.lastGameId = null;\r\n\r\n    // Start background processes\r\n    this._loadHistory();\r\n    this._ensurePollingAlarm();\r\n  }\r\n\r\n  // Durable Object lifecycle handler for background tasks\r\n  async alarm() {\r\n    await this._pollStake();\r\n    await this._ensurePollingAlarm(); // Set alarm again for the next cycle\r\n  }\r\n\r\n  // --- Storage Helpers ---\r\n\r\n  async _loadHistory() {\r\n    const raw = await this.state.storage.get(\"history\");\r\n    if (raw) {\r\n      this.history = JSON.parse(raw);\r\n      this.lastGameId = this.history[0]?.id || null;\r\n      console.log(`DO: Loaded ${this.history.length} historical rounds.`);\r\n    }\r\n  }\r\n\r\n  async _saveHistory() {\r\n    await this.state.storage.put(\"history\", JSON.stringify(this.history));\r\n  }\r\n\r\n  async _ensurePollingAlarm() {\r\n    const alarm = await this.state.storage.getAlarm();\r\n    // Only set a new alarm if one is not already scheduled\r\n    if (alarm === null || alarm.getTime() < Date.now()) {\r\n      // Set to run again in 4 seconds\r\n      await this.state.storage.setAlarm(Date.now() + 4000); \r\n    }\r\n  }\r\n\r\n  // --- Secure Polling Logic (Using STAKE_TOKEN) ---\r\n\r\n  async _pollStake() {\r\n    // Only poll if the STAKE_TOKEN is set\r\n    if (!this.env.STAKE_TOKEN) {\r\n      console.error(\"DO Error: STAKE_TOKEN is missing from environment variables.\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const response = await fetch('https://stake.com/graphql', {\r\n        method: 'POST',\r\n        headers: {\r\n        'Content-Type': 'application/json',\r\n        // New Header: Add a standard browser User-Agent string\r\n        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.75 Safari/537.36',\r\n        'x-session-token': this.env.STAKE_TOKEN,\r\n    },\r\n        body: JSON.stringify({\r\n          operationName: 'CasinoGameCrashHistory',\r\n          query: `query CasinoGameCrashHistory($game: String!) { \r\n              crash: casinoGameCrashHistory(game: $game) { \r\n                  game { \r\n                      id \r\n                      state \r\n                      crashPoint \r\n                      hash \r\n                  } \r\n              } \r\n          }`,\r\n          variables: { game: 'crash' }\r\n        })\r\n      });\r\n\r\n      if (response.status === 403) {\r\n        // This is the common \"token expired\" error\r\n        console.error(\"DO Error: 403 \u2014 Token expired or IP flagged. Update STAKE_TOKEN.\");\r\n        return; // Stop processing this cycle\r\n      }\r\n\r\n      // Check for non-JSON content (like the HTML error you saw)\r\n      if (!response.headers.get('Content-Type')?.includes('application/json')) {\r\n         const text = await response.text();\r\n         console.error(`DO Error during pollStake: Received non-JSON response (Status ${response.status}): ${text.slice(0, 50)}...`);\r\n         return;\r\n      }\r\n\r\n      const json = await response.json();\r\n      const game = json?.data?.crash?.game;\r\n\r\n      if (game && game.id !== this.lastGameId && game.state === \"crashed\") {\r\n        this.lastGameId = game.id;\r\n        const crashData = {\r\n          id: game.id,\r\n          multiplier: parseFloat(game.crashPoint),\r\n          status: \"crash\",\r\n          hash: { hash: game.hash }\r\n        };\r\n\r\n        // Save and broadcast\r\n        this.history.unshift(crashData);\r\n        if (this.history.length > 500) this.history.pop();\r\n        await this._saveHistory();\r\n\r\n        console.log(`DO: CRASHED @ ${crashData.multiplier.toFixed(2)}x. Total: ${this.history.length}`);\r\n\r\n        // Broadcast to all connected clients\r\n        for (const c of this.clients) {\r\n          try {\r\n            // We use the 'crash' type here (instead of 'liveMultiplierUpdate') \r\n            // to send the final result to the frontend.\r\n            c.send(JSON.stringify({ type: 'crash', data: crashData }));\r\n          } catch (_) { }\r\n        }\r\n      }\r\n\r\n    } catch (e) {\r\n      console.error(`DO Error during pollStake: ${e.message}`);\r\n    }\r\n  }\r\n\r\n  // --- WebSocket Handlers ---\r\n\r\n  async fetch(request) {\r\n    if (request.headers.get(\"upgrade\")?.toLowerCase() !== \"websocket\") {\r\n      return new Response(\"Expected WebSocket\", { status: 400 });\r\n    }\r\n\r\n    const pair = new WebSocketPair();\r\n    const client = pair[0];\r\n    const server = pair[1];\r\n\r\n    server.accept();\r\n    this._attachClient(server);\r\n\r\n    return new Response(null, { status: 101, webSocket: client });\r\n  }\r\n\r\n  _attachClient(ws) {\r\n    // Send history immediately (as per your frontend expectation)\r\n    try {\r\n      ws.send(JSON.stringify({ type: \"history\", data: this.history }));\r\n    } catch (e) {\r\n      console.error(\"DO: Error sending history:\", e);\r\n    }\r\n\r\n    this.clients.add(ws);\r\n\r\n    // Remove client on disconnect\r\n    ws.addEventListener(\"close\", () => this.clients.delete(ws));\r\n    ws.addEventListener(\"error\", () => this.clients.delete(ws));\r\n  }\r\n}", "\r\n// stake-worker/src/worker-router.js\r\n\r\n// Export the Durable Object class so Cloudflare registers it\r\nexport { default as OracleDO } from \"./oracle_do.js\";\r\n\r\nexport default {\r\n  async fetch(request, env) {\r\n    const url = new URL(request.url);\r\n\r\n    // Only WebSocket traffic goes to Durable Object\r\n    if (url.pathname === \"/ws\") {\r\n      const upgrade = request.headers.get(\"upgrade\");\r\n\r\n      if (!upgrade || upgrade.toLowerCase() !== \"websocket\") {\r\n        return new Response(\"WebSocket endpoint only\", { status: 400 });\r\n      }\r\n\r\n      // Get the fixed DO instance\r\n      const id = env.ORACLE_DO.idFromName(\"GLOBAL_ORACLE\");\r\n      const stub = env.ORACLE_DO.get(id);\r\n\r\n      // Forward the request to the DO\r\n      return stub.fetch(request);\r\n    }\r\n\r\n    return new Response(\"Stake Oracle Worker Running\", { status: 200 });\r\n  }\r\n};\r\n\r\n"],
  "mappings": "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",
  "names": []
}
